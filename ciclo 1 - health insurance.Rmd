---
date: "`r format(Sys.time(), '%d/%m/%Y')`"
output: 
    html_document:
      highlight: textmate
      logo: logo.png
      theme: jou
      number_sections: yes
      toc: yes
      toc_float:
        collapsed: yes
        smooth_scroll: no
      df_print: paged
      code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

# 1. Import

```{r}
library(tidyverse)
library(readr)
library(janitor)
library(gtsummary)
library(summarytools)
library(kableExtra)
library(gridExtra)
library(ggplot2)
library(ggpubr)
```

# 2. Data Collection

```{r}
#
df <- read_csv("datasets/train.csv")
```

# 3. Data Cleaning

```{r}
# "limpa" os nomes das colunas da tabela
df1 <- janitor::clean_names(df)
```

## 3.1 Data Types

```{r}
# construção de uma tabela com os nomes das variáveis e os tipos
tibble(variables = names(df1),
       types = unlist(lapply(df1, class)))
```

## 3.2 Renomeações

Aqui faremos algumas recomeações de nomes de colunas e de alguns valores.

```{r}
# rename: renomea os nomes das colunas
# mutate: aplica uma função dentro das colunas
# mutate_if: para transformar as variaveis categoricas em factor (precisa para o modelo)
df2 <- df1 %>% 
  rename(days_associated = vintage,
        health_annual_paid  = annual_premium) %>% 
  mutate(
    across(where(is.character), tolower),
    driving_license = ifelse(driving_license == 1, "yes", "no"),
    previously_insured = ifelse(previously_insured == 1, "yes", "no"),
    response = ifelse(response == 1, "yes", "no"),
    vehicle_age = case_when(
      vehicle_age == "< 1 year" ~ "below_1_year",
      vehicle_age == "1-2 year" ~ "between_1_2_years",
      vehicle_age == "> 2 years" ~ "over_2_years"
    )) %>%
  mutate_if(is.character, as.factor)

# Para o modelo é necessário que a variável positiva seja a primeira. Para isso, vamos garantir a ordem.
df2 <- df2 %>% 
   mutate(response = factor(response, levels = c("yes", "no")),
          driving_license = factor(driving_license, level = c("yes", 'no')),
          previously_insured = factor(previously_insured, levels = c("yes", "no")),
          vehicle_damage = factor(vehicle_damage, levels = c("yes", "no")))

head(df2)

# Salvar df2 como RDS, para que não próxima vez que abrirmos o porjeto não seja necessário rodar tudo.
saveRDS(df2, "df_cleaned.rds")
```

## 3.3 Descrição das Colunas

```{r}
variables <- df2 %>% names()
description <- c(
  "Unique ID for the customer",
  "Gender of the customer",
  "Age of the customer",
  "Drinving license (yes / no)",
  "Unique code for the region of the customer",
  "Customer already has Vehicle Insurance (yes / no)",
  "Age of the Vehicle",
  "Customer got his/her vehicle damaged in the past (yes / no)",
  "The amount customer needs to pay as premium in the year",
  "Anonymized Code for the channel of outreaching to the customer ie. Different Agents, Over Mail, Over Phone, In Person, etc.",
  "Number of Days, Customer has been associated with the company",
  "Customer is interested (yes / no)")

df_description <- tibble(variables = variables,
                         description = description)

kable(data.frame(df_description), format='html') %>% 
  kable_styling(bootstrap_options = 'striped',
                full_width = FALSE)
```

## 3.4 Estatística Descritiva

```{r}
# Ler os dados que foram salvos anteriormente em RDS
df_cleaned <- readRDS('df_cleaned.rds')
```

```{r}
# Estatística Descritiva
skimr::skim(df_cleaned)
```

```{r}
# resumo de descrição de cada atributo
df_cleaned %>% 
  select(-id) %>%
  tbl_summary(
    type = list(response ~ "categorical",
                driving_license ~ "categorical",
                previously_insured ~ "categorical",
                vehicle_damage ~ "categorical"),
    digits = list(all_categorical() ~ c(0,2))
      )
```

Essas estatísticas são muito úteis para se ter um breve overview dos dados, mas precisamos ir um pouco mais além. Para isso, vamos construir uma visão mais detalhada para os dados numéricos.

```{r}
num_attributes <- df_cleaned %>% 
  select(age, health_annual_paid, days_associated)
```

```{r}
descritive_table <- descr(num_attributes, style = 'rmarkdown') %>% 
                          round(2)

kable(data.frame(descritive_table), format='html') %>% 
  kable_styling(bootstrap_options = 'striped',
                full_width = FALSE)
```

Vamos criar uma visualização gráfica.

```{r}
# Age
age_plt <- num_attributes %>% 
  ggplot(aes(x = age)) +
  geom_histogram(aes(y = after_stat(density)), binwidth = 2,
                 color = "black", fill = "lightgreen", alpha = 0.5)  + 
  geom_density(color = 'black', size = 1) + 
  labs(x = "Age", y = "Density", title = "Customers Age Distribution")  + 
  theme_minimal()

# Days Associated
days_plt <- num_attributes %>% 
  ggplot(aes(x = days_associated)) +
  geom_histogram(aes(y = after_stat(density)), binwidth = 10,
                 color = "black", fill = "lightgreen", alpha = 0.5)  + 
  geom_density(color = 'black', size = 1) + 
  labs(x = "Days Associated", y = "Density", title = "Customers Days Associated Distribution")  + 
  theme_minimal()

# Health Annual paid
paid_plt <- num_attributes %>% 
  ggplot(aes(x = health_annual_paid)) +
  geom_histogram(aes(y = after_stat(density)), binwidth = 10000,
                 color = "black", fill = "lightgreen", alpha = 0.5)  + 
  geom_density(color = 'black', size = 1) + 
  labs(x = "Health Annual Age", y = "Density", title = "Customers Health Annual Paid Distribution")  + 
  theme_minimal()

# Grid
grid.arrange(age_plt, days_plt, paid_plt)
```

Agora, vamos analisar as variáveis categóricas.

```{r}
num_names <- names(num_attributes)
cat_attributes <- df_cleaned %>% 
  select(-id, -one_of(num_names))
```

```{r}
# Gender
gender_plt <- cat_attributes %>% 
  ggplot(aes(x = gender)) +
  geom_bar(aes(fill = gender), color = 'black') + 
  labs(x = "Gender", y = "Count", title = "Customers\nGender")  + 
    scale_fill_manual(values=c("lightgreen",
                               "darkgreen"), name = 'Region Code') +
  theme_minimal() + 
  theme(legend.position="none")

# Driving License
driving_plt <- cat_attributes %>% 
  ggplot(aes(x = driving_license)) +
  geom_bar(aes(fill = driving_license), color = 'black') + 
  labs(x = "Driving License", y = "Count", title = "Customers\nDriving License")  + 
    scale_fill_manual(values=c("lightgreen",
                               "darkgreen"), name = 'Region Code') +
  theme_minimal()+ 
  theme(legend.position="none")

# Region Code
region_plt <- cat_attributes %>% 
  ggplot(aes(x = factor(region_code))) +
  geom_bar(aes(fill = region_code), color = 'black') + 
  labs(x = "Region Code", y = "Count", title = "Customers\nRegion Code")  + 
  scale_fill_gradient(low='lightgreen', high='darkgreen', name = 'Region Code') +
  theme_minimal()+ 
  theme(legend.position="none", axis.text.x = element_blank())

# Previously Insured
insured_plt <- cat_attributes %>% 
  ggplot(aes(x = previously_insured)) +
  geom_bar(aes(fill = previously_insured), color = 'black') + 
  labs(x = "Previously Insured", y = "Count", title = "Customers\nPreviously Insured")  + 
    scale_fill_manual(values=c("lightgreen",
                               "darkgreen"), name="Previously Insured") +
  theme_minimal()+ 
  theme(legend.position="none")

# Vehicle Age
vehicle_age_plt <- cat_attributes %>% 
  ggplot(aes(x = vehicle_age)) +
  geom_bar(aes(fill = vehicle_age), color = 'black') + 
  labs(x = "Vehicle Age", y = "Count", title = "Customers Vehicle\nAge")  +
  scale_fill_manual(values=c("lightgreen",
                             "#71C55B",
                             "darkgreen"), name="Vehicle Age") +
  theme_minimal()+ 
  theme(legend.position="none")

# Vehicle Damage
vehicle_dmg_plt <- cat_attributes %>% 
  ggplot(aes(x = vehicle_damage)) +
  geom_bar(aes(fill = vehicle_damage), color = 'black') + 
  labs(x = "Vehicle Damage", y = "Count", title = "Customers\nVehicle Damage")  + 
    scale_fill_manual(values=c("lightgreen",
                               "darkgreen"), name="Vehicle Damage") +
  theme_minimal()+ 
  theme(legend.position="none")

# Policy Sales Channel
sales_channel_plt <- cat_attributes %>% 
  ggplot(aes(x = factor(policy_sales_channel))) +
  geom_bar(aes(fill = policy_sales_channel), color = 'black') + 
  labs(x = "Policy Sales Channel", y = "Count", title = "Customers\nPolicy Sales Channel")  + 
  scale_fill_gradient(low='lightgreen', high='darkgreen', name = 'Policy Sales Channel') +
  theme_minimal()+ 
  theme(legend.position="none", axis.text.x = element_blank())

# Response
response_plt <- cat_attributes %>% 
  ggplot(aes(x = response)) +
  geom_bar(aes(fill = response), color = 'black') + 
  labs(x = "Response", y = "Count", title = "Customers\nResponse")  + 
    scale_fill_manual(values=c("lightgreen",
                               "darkgreen"), name="Response") +
  theme_minimal()+ 
  theme(legend.position="none")

# Grid
graficos_combinados <- ggarrange(gender_plt,
                                 driving_plt,
                                 region_plt,
                                 insured_plt,
                                 vehicle_age_plt,
                                 vehicle_dmg_plt,
                                 sales_channel_plt,
                                 response_plt,
                                 ncol = 2, nrow = 4);


```

```{r}
plot(graficos_combinados)
```
